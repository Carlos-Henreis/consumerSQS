FROM alpine:latest

USER root
RUN apk --update add openjdk11
RUN rm -rf /var/cache/apk/*

RUN apk --update add fontconfig ttf-dejavu

ENV spring.profiles.active=aws

WORKDIR /app


COPY ocr*.jar /app/ocr.jar
COPY src/main/resources/application.properties /app/application.properties
COPY src/main/resources/fonts /app/fonts
ENTRYPOINT ["java", "-jar", "-Xms256m", "-Xmx512m", "-Duser.timezone=America/Sao_Paulo", "-Duser.language=pt-BR", "/app/ocr.jar", "--server.port=8080"]
EXPOSE 8080







FROM alpine:latest

USER root
RUN apk --update add openjdk11
RUN rm -rf /var/cache/apk/*

ENV spring.profiles.active=aws

# Instalação de certificados
COPY ca_bundle.crt /usr/local/share/ca-certificates/ca_bundle.crt
RUN update-ca-certificates

COPY apicommongeracaopdf*.jar /app/apicommongeracaopdf.jar
COPY src/main/resources/application-aws.yml /app/application.yml
ADD src/main/resources/fonts /app/fonts
ENTRYPOINT ["java", "-jar", "-Xms256m", "-Xmx512m", "-Duser.timezone=America/Sao_Paulo", "-Duser.language=pt-BR", "/app/apicommongeracaopdf.jar", "--server.port=8080"]
EXPOSE 8080


version: 0.2
env:
  shell: bash
phases:
  install:
    runtime-versions:
      python: "3.7"
    commands:
      # INSTALANDO O AWSCLI PARA EXECUCAO DOS SCRIPTS
      - pip install --upgrade pip
      - pip install --upgrade awscli
      # INSTALANDO YQ PARA PARSE DO DEPLOYMENT.YAML
      - pip install --upgrade yq
      # DISPLAY VERSION INFORMATION FOR INSTALLED PACKAGES
      - python -V
      - pip -V
      - aws --version
      - yq --version
  pre_build:
    commands:
      # LEITURA DO ARQUIVO DE IMAGEDEFINITIONS.JSON
      - |
        if [ ! -z "$CODEBUILD_SRC_DIR_Publishecrdev" ]; then
          PUBLISH=$CODEBUILD_SRC_DIR_Publishecrdev
        elif [ ! -z "$CODEBUILD_SRC_DIR_PublishDev" ]; then
          PUBLISH=$CODEBUILD_SRC_DIR_PublishDev
        fi
      - export IMAGE_TAG=$(cat $PUBLISH/imagedefinitions.json | jq -r '.[].imageUri')
      # EXECUTA ASSUME ROLE PARA A CONTA E INSTALA O KUBECTL NA VERSAO DO CLUSTER
      - source $CODEBUILD_SRC_DIR/eks/deploy/assume_role.sh "${DevAccount}"
  build:
    commands:
      - ls -la
      # GERA OS ARQUIVOS DE DEPLOYMENT E EFETUA O DEPLOY NO CLUSTER
      - bash $CODEBUILD_SRC_DIR_App/pipeline/eks/deploy/deploy_rollout.sh "$CODEBUILD_SRC_DIR_App/infra/parameters-dev.json"
artifacts:
  files:
    - $CODEBUILD_SRC_DIR_App/infra/eks/generate_files_k8s/*
  discard-paths: yes
  
  
  
  package br.com.carloshenreis.utils;

import org.springframework.beans.factory.annotation.Value;
import org.springframework.stereotype.Component;

import java.io.File;
import java.io.IOException;
import java.io.InputStream;
import java.net.URI;
import java.net.URISyntaxException;
import java.net.URL;
import java.nio.file.*;
import java.util.Collections;
import java.util.List;
import java.util.stream.Collectors;

@Component
public class FileResourcesUtils {

    @Value("${spring.profiles.active:}")
    private String activeProfiles;

    public InputStream getFileFromResourceAsStream(String fileName) {

        ClassLoader classLoader = getClass().getClassLoader();
        InputStream inputStream = classLoader.getResourceAsStream(fileName);

        // the stream holding the file content
        if (inputStream == null) {
            throw new IllegalArgumentException("file not found! " + fileName);
        } else {
            return inputStream;
        }

    }

    public Path getPathsFromFolder(String folder) throws URISyntaxException, IOException {

        if (activeProfiles.contains("local")) return this.getAllFilesFromResource(folder);
        else return this.getPathsFromResourceJAR(folder);

    }

    private Path getPathsFromResourceJAR(String folder) throws URISyntaxException, IOException {
        Path path = Path.of("fonts/");
        System.out.println(path.toAbsolutePath());
        return path;
    }

    private Path getAllFilesFromResource(String folder) throws URISyntaxException, IOException {

        ClassLoader classLoader = getClass().getClassLoader();
        URI uri = classLoader.getResource(folder).toURI();
        String filePath = uri.getPath();
        if (filePath.startsWith("/")) {
            filePath = filePath.substring(1, filePath.length());
        }

        return Path.of(filePath);

    }
}
